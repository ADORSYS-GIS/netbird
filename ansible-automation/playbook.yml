---
# Main Ansible playbook for deploying NetBird with Caddy as a reverse proxy.
# This playbook orchestrates the entire deployment process, including system preparation
# and the deployment of NetBird services with Caddy.

- name: Deploy NetBird with Caddy Reverse Proxy
  hosts: netbird_servers
  become: true
  gather_facts: true

  tasks:
    # Pre-flight Checklist
    - name: Pre-flight | Check if Docker is installed and running
      ansible.builtin.shell: docker info
      register: docker_check
      changed_when: false
      failed_when: docker_check.rc != 0
      ignore_errors: false

    - name: Pre-flight | Validate required variables
      ansible.builtin.assert:
        that:
          - netbird_domain is defined
          - netbird_management_secret is defined
          - netbird_relay_secret is defined
          - netbird_turn_secret is defined
        fail_msg: "One or more required variables are missing. Please check your inventory."

    # Task: Create the main deployment directory for NetBird.
    - name: Create NetBird deployment directory
      ansible.builtin.file:
        path: /opt/netbird
        state: directory
        mode: '0755'

    # Task: Generate the Caddyfile from its Jinja2 template.
    - name: Generate Caddyfile
      ansible.builtin.template:
        src: templates/Caddyfile.j2
        dest: /opt/netbird/Caddyfile
        mode: '0644'
      tags: config

    # Task: Generate the docker-compose.yml file from its Jinja2 template.
    - name: Generate docker-compose.yml
      ansible.builtin.template:
        src: templates/docker-compose.yml.j2
        dest: /opt/netbird/docker-compose.yml
        mode: '0644'
      tags: config

    # Task: Generate the management.json file from its Jinja2 template.
    - name: Generate management.json
      ansible.builtin.template:
        src: templates/management.json.j2
        dest: /opt/netbird/management.json
        mode: '0644'
      tags: config

    # Task: Generate the turnserver.conf file from its Jinja2 template.
    - name: Generate turnserver.conf
      ansible.builtin.template:
        src: templates/turnserver.conf.j2
        dest: /opt/netbird/turnserver.conf
        mode: '0644'
      tags: config

    # Task: Start NetBird services using Docker Compose.
    - name: Start NetBird services with Docker Compose
      community.docker.docker_compose_v2:
        project_src: /opt/netbird
        state: present
        pull: always
        remove_orphans: true
      environment:
        NETBIRD_DOMAIN: "{{ netbird_domain }}"
        NETBIRD_CADDY_EMAIL: "{{ netbird_caddy_email }}"
        NETBIRD_AUTH_AUDIENCE: "{{ netbird_auth_audience }}"
        NETBIRD_AUTH_CLIENT_ID: "{{ netbird_auth_client_id }}"
        NETBIRD_AUTH_AUTHORITY: "{{ netbird_auth_authority }}"
        NETBIRD_RELAY_SECRET: "{{ netbird_relay_secret }}"
        NETBIRD_TURN_SECRET: "{{ netbird_turn_secret }}"
        NETBIRD_TURN_PASSWORD: "{{ netbird_turn_password }}"
        NETBIRD_DATASTORE_ENCRYPTION_KEY: "{{ netbird_datastore_encryption_key }}"