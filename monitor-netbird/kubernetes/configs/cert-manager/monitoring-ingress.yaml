apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: monitoring-stack-ingress
  namespace: observability
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
spec:
  tls:
  - hosts:
    - grafana.<YOUR_MONITORING_DOMAIN>
    - loki.<YOUR_MONITORING_DOMAIN>
    - mimir.<YOUR_MONITORING_DOMAIN>
    - tempo.<YOUR_MONITORING_DOMAIN>
    - tempo-push.<YOUR_MONITORING_DOMAIN>
    - prometheus.<YOUR_MONITORING_DOMAIN>
    secretName: monitoring-tls

  rules:
  # Grafana
  - host: grafana.<YOUR_MONITORING_DOMAIN>
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: monitoring-stack-grafana
            port:
              number: 80

  # Loki
  - host: loki.<YOUR_MONITORING_DOMAIN>
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: monitoring-stack-loki-gateway
            port:
              number: 80

  # Mimir
  - host: mimir.<YOUR_MONITORING_DOMAIN>
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: monitoring-stack-mimir-nginx
            port:
              number: 80

  # Tempo - Query Endpoint (for Grafana to query traces)
  - host: tempo.<YOUR_MONITORING_DOMAIN>
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: monitoring-stack-tempo-query-frontend
            port:
              number: 3200

  # Tempo - Push Endpoint (for applications/collectors to push traces via HTTP)
  - host: tempo-push.<YOUR_MONITORING_DOMAIN>
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: monitoring-stack-tempo-distributor
            port:
              number: 4318

  # Prometheus
  - host: prometheus.<YOUR_MONITORING_DOMAIN>
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: monitoring-stack-prometheus-server
            port:
              number: 80

---
# Tempo gRPC Ingress - For OTLP gRPC trace ingestion
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: monitoring-stack-ingress-grpc
  namespace: observability
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
spec:
  tls:
  - hosts:
    - tempo-grpc.<YOUR_MONITORING_DOMAIN>
    secretName: monitoring-grpc-tls

  rules:
  - host: tempo-grpc.<YOUR_MONITORING_DOMAIN>
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: monitoring-stack-tempo-distributor
            port:
              number: 4317
