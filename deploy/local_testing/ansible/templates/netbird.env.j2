# NetBird Control Plane Configuration with Keycloak
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

# Domain and Network Settings
# Using dynamic IP detection to fix localhost issues
NETBIRD_DOMAIN={{ netbird_external_domain }}
NETBIRD_LETSENCRYPT_DOMAIN={{ netbird_external_domain }}
NETBIRD_LETSENCRYPT_EMAIL=admin@{{ netbird_external_domain }}

# External IP for client access
NETBIRD_EXTERNAL_IP={{ netbird_external_ip }}

# Service Ports
NETBIRD_DASHBOARD_PORT={{ netbird_dashboard_port }}
NETBIRD_MANAGEMENT_PORT={{ netbird_management_port }}
NETBIRD_STUN_PORT={{ netbird_stun_port }}

# Database Configuration (PostgreSQL for production)
NETBIRD_STORE_CONFIG_ENGINE=postgres
POSTGRES_DB={{ postgres_db }}
POSTGRES_USER={{ postgres_user }}
POSTGRES_PASSWORD={{ postgres_password }}
NETBIRD_STORE_ENGINE_POSTGRES_DSN=postgres://{{ postgres_user }}:{{ postgres_password_encoded }}@postgres:5432/{{ postgres_db }}?sslmode=disable

# Keycloak Identity Provider Configuration
NETBIRD_MGMT_IDP=keycloak
KEYCLOAK_REALM={{ keycloak_realm }}
KEYCLOAK_PORT={{ netbird_keycloak_port }}
KEYCLOAK_ADMIN={{ keycloak_admin_user }}
KEYCLOAK_ADMIN_PASSWORD={{ keycloak_admin_password }}
KEYCLOAK_DB_VENDOR={{ keycloak_db_vendor }}
KEYCLOAK_DB_URL=jdbc:postgresql://postgres:5432/keycloak
KEYCLOAK_DB_USERNAME={{ postgres_user }}
KEYCLOAK_DB_PASSWORD={{ postgres_password }}
KEYCLOAK_HTTP_PORT={{ netbird_keycloak_port }}

# Authentication Configuration
# External URLs for browser access (uses external domain/IP)
NETBIRD_AUTH_AUTHORITY=http://{{ netbird_external_domain }}:{{ netbird_keycloak_port }}/realms/{{ keycloak_realm }}

# Internal URLs for service-to-service communication (uses container names)
NETBIRD_AUTH_CLIENT_ID=netbird-client
NETBIRD_AUTH_CLIENT_SECRET={{ netbird_auth_client_secret }}
NETBIRD_AUTH_JWT_CERTS=http://keycloak:{{ netbird_keycloak_port }}/realms/{{ keycloak_realm }}/protocol/openid-connect/certs
NETBIRD_AUTH_OIDC_CONFIGURATION_ENDPOINT=http://keycloak:{{ netbird_keycloak_port }}/realms/{{ keycloak_realm }}/.well-known/openid-configuration
NETBIRD_AUTH_TOKEN_ENDPOINT=http://keycloak:{{ netbird_keycloak_port }}/realms/{{ keycloak_realm }}/protocol/openid-connect/token
NETBIRD_AUTH_USER_ID_CLAIM=sub
NETBIRD_AUTH_AUDIENCE=netbird-client
NETBIRD_DASH_AUTH_AUDIENCE=netbird-client

# NetBird Management API
NETBIRD_MGMT_API_PORT={{ netbird_management_port }}
NETBIRD_MGMT_SINGLE_ACCOUNT_MODE_DOMAIN={{ netbird_mgmt_single_account_mode_domain }}
NETBIRD_MGMT_IDP_SIGNKEY_REFRESH={{ netbird_mgmt_idp_signkey_refresh }}

# NetBird Signal Server
NETBIRD_SIGNAL_PORT={{ netbird_signal_port }}
NETBIRD_SIGNAL_PROTOCOL={{ netbird_signal_protocol }}

# NetBird Relay Server
NETBIRD_RELAY_PORT={{ netbird_relay_port }}
NETBIRD_RELAY_AUTH_SECRET={{ relay_auth_secret }}

# TURN Server Configuration
TURN_DOMAIN={{ turn_domain }}
TURN_USER={{ turn_user }}
TURN_PASSWORD={{ turn_password }}

# Security
NETBIRD_DATASTORE_ENC_KEY={{ datastore_enc_key }}

# Device Authorization Flow (for CLI clients)
NETBIRD_AUTH_DEVICE_AUTH_PROVIDER=keycloak
NETBIRD_AUTH_DEVICE_AUTH_CLIENT_ID=netbird-device
NETBIRD_AUTH_DEVICE_AUTH_AUDIENCE=netbird-client
NETBIRD_AUTH_DEVICE_AUTH_ENDPOINT=http://keycloak:{{ netbird_keycloak_port }}/realms/{{ keycloak_realm }}/protocol/openid-connect/auth/device
NETBIRD_AUTH_DEVICE_AUTH_SCOPE="openid profile email"
NETBIRD_AUTH_DEVICE_AUTH_USE_ID_TOKEN=false

# PKCE Authorization Flow (Fixed URLs for external access)
NETBIRD_AUTH_PKCE_AUDIENCE=netbird-client
NETBIRD_AUTH_PKCE_AUTHORIZATION_ENDPOINT=http://{{ netbird_external_domain }}:{{ netbird_keycloak_port }}/realms/{{ keycloak_realm }}/protocol/openid-connect/auth
NETBIRD_AUTH_PKCE_REDIRECT_URLS=http://{{ netbird_external_domain }}:{{ netbird_dashboard_port }}/
NETBIRD_AUTH_PKCE_USE_ID_TOKEN=false
NETBIRD_AUTH_PKCE_DISABLE_PROMPT_LOGIN=false
NETBIRD_AUTH_PKCE_LOGIN_FLAG=false
NETBIRD_AUTH_SUPPORTED_SCOPES="openid profile email"

# Management Client Configuration
NETBIRD_IDP_MGMT_CLIENT_ID=netbird-management
NETBIRD_IDP_MGMT_CLIENT_SECRET={{ keycloak_mgmt_secret }}

# IDP Manager Configuration (internal service communication)
NETBIRD_IDP_MGMT_ENDPOINT=http://keycloak:{{ netbird_keycloak_port }}/realms/{{ keycloak_realm }}
NETBIRD_IDP_MGMT_ADMIN_ENDPOINT=http://keycloak:{{ netbird_keycloak_port }}/admin/realms/{{ keycloak_realm }}

# Optional Settings
NETBIRD_DISABLE_ANONYMOUS_METRICS={{ netbird_disable_anonymous_metrics }}
