#!/bin/bash
# NetBird Backup Script
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

set -e

BACKUP_DIR="{{ netbird_base_dir }}/backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="netbird_backup_${TIMESTAMP}"

echo "=== NetBird Backup Script ==="
echo "Starting backup at $(date)"

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Change to NetBird directory
cd {{ netbird_base_dir }}

echo "Creating backup: $BACKUP_NAME"

# Create backup archive
tar -czf "$BACKUP_DIR/${BACKUP_NAME}.tar.gz" \
    --exclude="backups" \
    --exclude="data/postgres_data" \
    config/ \
    scripts/ \
    docker-compose.yml \
    .env \
    management.json \
    turnserver.conf \
    init-databases.sh

echo "âœ… Configuration backup created: $BACKUP_DIR/${BACKUP_NAME}.tar.gz"

# Backup PostgreSQL databases
echo "Backing up PostgreSQL databases..."

# Backup NetBird database
docker compose exec -T postgres pg_dump -U {{ postgres_user }} {{ postgres_db }} > "$BACKUP_DIR/${BACKUP_NAME}_netbird.sql"
echo "âœ… NetBird database backed up"

# Backup Keycloak database
docker compose exec -T postgres pg_dump -U {{ postgres_user }} keycloak > "$BACKUP_DIR/${BACKUP_NAME}_keycloak.sql"
echo "âœ… Keycloak database backed up"

# Create backup info file
cat > "$BACKUP_DIR/${BACKUP_NAME}_info.txt" << EOF
NetBird Backup Information
==========================
Backup Date: $(date)
Backup Name: $BACKUP_NAME
Domain: {{ netbird_external_domain }}
External IP: {{ netbird_external_ip }}

Files Included:
- Configuration files (config/)
- Scripts (scripts/)
- Docker Compose configuration
- Environment files
- Management configuration
- TURN server configuration
- Database initialization script
- NetBird PostgreSQL database
- Keycloak PostgreSQL database

Restore Instructions:
1. Extract configuration: tar -xzf ${BACKUP_NAME}.tar.gz
2. Restore NetBird DB: docker compose exec -T postgres psql -U {{ postgres_user }} -d {{ postgres_db }} < ${BACKUP_NAME}_netbird.sql
3. Restore Keycloak DB: docker compose exec -T postgres psql -U {{ postgres_user }} -d keycloak < ${BACKUP_NAME}_keycloak.sql
4. Restart services: docker compose restart
EOF

echo "âœ… Backup info created: $BACKUP_DIR/${BACKUP_NAME}_info.txt"

# Clean up old backups (keep last {{ backup_retention_days | default(7) }} days)
echo "Cleaning up old backups..."
find "$BACKUP_DIR" -name "netbird_backup_*" -type f -mtime +{{ backup_retention_days | default(7) }} -delete
echo "âœ… Old backups cleaned up"

echo ""
echo "=== Backup Summary ==="
echo "ðŸ“ Backup location: $BACKUP_DIR"
echo "ðŸ“¦ Configuration: ${BACKUP_NAME}.tar.gz"
echo "ðŸ—„ï¸ NetBird DB: ${BACKUP_NAME}_netbird.sql"
echo "ðŸ—„ï¸ Keycloak DB: ${BACKUP_NAME}_keycloak.sql"
echo "ðŸ“„ Info file: ${BACKUP_NAME}_info.txt"
echo ""
echo "âœ… Backup completed successfully at $(date)"

# List current backups
echo ""
echo "=== Available Backups ==="
ls -lh "$BACKUP_DIR"/netbird_backup_* 2>/dev/null || echo "No previous backups found"
