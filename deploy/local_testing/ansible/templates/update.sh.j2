#!/bin/bash
# NetBird Update Script
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

set -e

echo "=== NetBird Update Script ==="
echo "Starting update at $(date)"

# Change to NetBird directory
cd {{ netbird_base_dir }}

# Function to backup before update
backup_before_update() {
    echo "Creating backup before update..."
    {{ netbird_scripts_dir }}/backup.sh
    echo "✅ Backup completed"
}

# Function to update Docker images
update_images() {
    echo "Pulling latest Docker images..."
    docker compose pull
    echo "✅ Images updated"
}

# Function to restart services
restart_services() {
    echo "Restarting NetBird services..."
    docker compose down
    docker compose up -d
    echo "✅ Services restarted"
}

# Function to check service health
check_health() {
    echo "Checking service health..."
    sleep 30
    
    # Check Keycloak
    if curl -s -f http://{{ netbird_external_domain }}:{{ netbird_keycloak_port }}/realms/master > /dev/null; then
        echo "✅ Keycloak is healthy"
    else
        echo "❌ Keycloak health check failed"
        return 1
    fi
    
    # Check Dashboard
    if curl -s -f http://{{ netbird_external_domain }}:{{ netbird_dashboard_port }} > /dev/null; then
        echo "✅ Dashboard is healthy"
    else
        echo "⚠️ Dashboard health check failed (may be normal during startup)"
    fi
    
    # Check Management API
    if curl -s http://{{ netbird_external_domain }}:{{ netbird_management_port }} > /dev/null; then
        echo "✅ Management API is responding"
    else
        echo "⚠️ Management API health check failed (may be normal during startup)"
    fi
}

# Function to show service status
show_status() {
    echo ""
    echo "=== Service Status ==="
    docker compose ps
    echo ""
    echo "=== Container Resources ==="
    docker stats --no-stream | head -10
}

# Main update process
echo "🔄 Starting NetBird update process..."

# Ask for confirmation
read -p "This will update NetBird services. Continue? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Update cancelled"
    exit 0
fi

# Create backup
backup_before_update

# Update images
update_images

# Restart services
restart_services

# Wait and check health
echo "Waiting for services to start..."
sleep 10

# Check health
if check_health; then
    echo ""
    echo "✅ Update completed successfully!"
else
    echo ""
    echo "⚠️ Update completed but some health checks failed"
    echo "Check the logs: docker compose logs -f"
fi

# Show final status
show_status

echo ""
echo "=== Update Summary ==="
echo "📅 Update Date: $(date)"
echo "🌐 Dashboard: http://{{ netbird_external_domain }}:{{ netbird_dashboard_port }}"
echo "🔐 Keycloak: http://{{ netbird_external_domain }}:{{ netbird_keycloak_port }}/admin"
echo "📡 Management: http://{{ netbird_external_domain }}:{{ netbird_management_port }}"
echo ""
echo "📋 Next Steps:"
echo "1. Test NetBird Dashboard access"
echo "2. Verify client connections"
echo "3. Check logs if any issues: docker compose logs -f"
echo ""
echo "🎉 NetBird update completed at $(date)"
