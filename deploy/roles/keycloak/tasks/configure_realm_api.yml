---
# API-based Keycloak configuration for EXTERNAL mode
# Uses Keycloak REST API for remote instances

# ========================================
# STEP 1: Authenticate and get admin token
# ========================================
- name: Authenticate with Keycloak using service account (client_credentials)
  ansible.builtin.uri:
    url: "{{ kc_base_url }}/realms/{{ kc_token_realm }}/protocol/openid-connect/token"
    method: POST
    body_format: form-urlencoded
    body:
      grant_type: "client_credentials"
      client_id: "{{ kc_admin_client_id }}"
      client_secret: "{{ kc_admin_client_secret }}"
    validate_certs: "{{ kc_validate_certs }}"
    status_code: 200
  register: token_response
  no_log: true

- name: Set admin token fact
  ansible.builtin.set_fact:
    keycloak_admin_token: "{{ token_response.json.access_token }}"
  no_log: true

# ========================================
# STEP 2: Check if realm exists
# ========================================
- name: Check if NetBird realm exists
  ansible.builtin.uri:
    url: "{{ kc_base_url }}/admin/realms/{{ kc_realm_name }}"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_admin_token }}"
    validate_certs: "{{ kc_validate_certs }}"
    status_code: [200, 404]
  register: get_realm_response
  failed_when: false

- name: Fail if realm doesn't exist in external mode
  ansible.builtin.fail:
    msg: |
      ‚ùå Realm '{{ kc_realm_name }}' does not exist on external Keycloak instance!
      
      EXTERNAL MODE requires the realm to be pre-created.
      Please create the realm manually via Keycloak Admin Console:
      {{ kc_public_url }}/admin/master/console/#/realms
  when: get_realm_response.status == 404

# ========================================
# STEP 3: Get existing clients
# ========================================
- name: Get existing clients in realm
  ansible.builtin.uri:
    url: "{{ kc_base_url }}/admin/realms/{{ kc_realm_name }}/clients"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_admin_token }}"
    validate_certs: "{{ kc_validate_certs }}"
    status_code: [200, 403, 404]
  register: existing_clients_response
  failed_when: false

- name: Debug - Show response from get clients
  ansible.builtin.debug:
    msg:
      - "Status: {{ existing_clients_response.status }}"
      - "Has JSON: {{ existing_clients_response.json is defined }}"
      - "Content-Type: {{ existing_clients_response.content_type | default('N/A') }}"

- name: Check if clients exist (when we have permissions)
  ansible.builtin.set_fact:
    netbird_client_exists: "{{ existing_clients_response.json | selectattr('clientId', 'equalto', keycloak_client_netbird) | list | length > 0 }}"
    netbird_backend_client_exists: "{{ existing_clients_response.json | selectattr('clientId', 'equalto', keycloak_client_netbird_backend) | list | length > 0 }}"
    can_manage_clients: true
    manual_mode: false
  when:
    - existing_clients_response.status == 200
    - existing_clients_response.json is defined

# If we got 403 (no permissions), assume clients exist and skip management
- name: Set client existence facts (no permissions or not found - assume exist)
  ansible.builtin.set_fact:
    netbird_client_exists: true
    netbird_backend_client_exists: true
    can_manage_clients: false
    manual_mode: true
  when: existing_clients_response.status in [403, 404]

- name: Display client management status
  ansible.builtin.debug:
    msg:
      - "{% if manual_mode | default(false) %}‚öôÔ∏è  MANUAL MODE: No permissions - clients must be pre-configured{% else %}ü§ñ AUTOMATIC MODE: Will manage clients via API{% endif %}"

# ========================================
# STEP 4: Create frontend client (if missing and we have permissions)
# ========================================
- name: Create netbird-client (public client) if it doesn't exist
  ansible.builtin.uri:
    url: "{{ kc_base_url }}/admin/realms/{{ kc_realm_name }}/clients"
    method: POST
    headers:
      Authorization: "Bearer {{ keycloak_admin_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      clientId: "{{ keycloak_client_netbird }}"
      name: "NetBird Client"
      description: "NetBird UI and CLI client"
      enabled: true
      clientAuthenticatorType: "client-secret"
      redirectUris: "{{ kc_redirect_uris }}"
      webOrigins: "{{ kc_web_origins }}"
      protocol: "openid-connect"
      publicClient: true
      directAccessGrantsEnabled: true
      implicitFlowEnabled: false
      standardFlowEnabled: true
      serviceAccountsEnabled: false
      authorizationServicesEnabled: false
      fullScopeAllowed: true
      consentRequired: false
      attributes:
        "pkce.code.challenge.method": "S256"
        "post.logout.redirect.uris": "+"
        "oauth2.device.authorization.grant.enabled": "true"
        "oidc.ciba.grant.enabled": "false"
        "backchannel.logout.session.required": "true"
        "backchannel.logout.revoke.offline.tokens": "false"
    validate_certs: "{{ kc_validate_certs }}"
    status_code: [201, 409]
  when:
    - not netbird_client_exists
    - can_manage_clients | default(true)
  register: create_netbird_client

- name: Get netbird-client details
  ansible.builtin.uri:
    url: "{{ kc_base_url }}/admin/realms/{{ kc_realm_name }}/clients?clientId={{ keycloak_client_netbird }}"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_admin_token }}"
    validate_certs: "{{ kc_validate_certs }}"
    status_code: 200
  register: get_netbird_client_response
  when: can_manage_clients | default(true)

- name: Set netbird-client UUID fact
  ansible.builtin.set_fact:
    netbird_client_uuid: "{{ get_netbird_client_response.json[0].id }}"
  when: can_manage_clients | default(true)

# ========================================
# STEP 5: Update client redirect URIs if already exists
# ========================================
- name: Update netbird-client redirect URIs (if already existed)
  ansible.builtin.uri:
    url: "{{ kc_base_url }}/admin/realms/{{ kc_realm_name }}/clients/{{ netbird_client_uuid }}"
    method: PUT
    headers:
      Authorization: "Bearer {{ keycloak_admin_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      id: "{{ netbird_client_uuid }}"
      clientId: "{{ keycloak_client_netbird }}"
      redirectUris: "{{ kc_redirect_uris | list }}"
      webOrigins: "{{ ([kc_web_origins] if kc_web_origins is string else kc_web_origins) | list }}"
      attributes:
        "oauth2.device.authorization.grant.enabled": "true"
    validate_certs: "{{ kc_validate_certs }}"
    status_code: [204, 200]
  when:
    - netbird_client_exists
    - can_manage_clients | default(true)

# ========================================
# STEP 6: Create backend service account client
# ========================================
- name: Create netbird-backend (service account) if it doesn't exist
  ansible.builtin.uri:
    url: "{{ kc_base_url }}/admin/realms/{{ kc_realm_name }}/clients"
    method: POST
    headers:
      Authorization: "Bearer {{ keycloak_admin_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      clientId: "{{ keycloak_client_netbird_backend }}"
      name: "NetBird Management API"
      description: "NetBird backend service account"
      enabled: true
      clientAuthenticatorType: "client-secret"
      protocol: "openid-connect"
      publicClient: false
      bearerOnly: false
      directAccessGrantsEnabled: false
      implicitFlowEnabled: false
      standardFlowEnabled: false
      serviceAccountsEnabled: true
      authorizationServicesEnabled: false
      fullScopeAllowed: true
      consentRequired: false
      attributes:
        "oauth2.device.authorization.grant.enabled": "false"
        "oidc.ciba.grant.enabled": "false"
    validate_certs: "{{ kc_validate_certs }}"
    status_code: [201, 409]
  when:
    - not netbird_backend_client_exists
    - can_manage_clients | default(true)
  register: create_netbird_backend

- name: Get netbird-backend client details
  ansible.builtin.uri:
    url: "{{ kc_base_url }}/admin/realms/{{ kc_realm_name }}/clients?clientId={{ keycloak_client_netbird_backend }}"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_admin_token }}"
    validate_certs: "{{ kc_validate_certs }}"
    status_code: 200
  register: get_backend_client_response
  when: can_manage_clients | default(true)

- name: Fail if netbird-backend client was not found
  ansible.builtin.fail:
    msg: "netbird-backend client was not found in realm {{ kc_realm_name }}"
  when:
    - can_manage_clients | default(true)
    - get_backend_client_response.json | length == 0

- name: Set netbird-backend client UUID fact
  ansible.builtin.set_fact:
    netbird_backend_client_uuid: "{{ get_backend_client_response.json[0].id }}"
  when: can_manage_clients | default(true)

# ========================================
# STEP 7: Assign user management roles
# ========================================
- name: Get netbird-backend service account user
  ansible.builtin.uri:
    url: "{{ kc_base_url }}/admin/realms/{{ kc_realm_name }}/clients/{{ netbird_backend_client_uuid }}/service-account-user"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_admin_token }}"
    validate_certs: "{{ kc_validate_certs }}"
    status_code: 200
  register: get_service_account_user_response
  when: can_manage_clients | default(true)

- name: Set netbird-backend service account user ID fact
  ansible.builtin.set_fact:
    netbird_backend_service_account_user_id: "{{ get_service_account_user_response.json.id }}"
  when: can_manage_clients | default(true)

- name: Get realm-management client details
  ansible.builtin.uri:
    url: "{{ kc_base_url }}/admin/realms/{{ kc_realm_name }}/clients?clientId=realm-management"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_admin_token }}"
    validate_certs: "{{ kc_validate_certs }}"
    status_code: 200
  register: get_realm_management_client_response
  when: can_manage_clients | default(true)

- name: Set realm-management client UUID fact
  ansible.builtin.set_fact:
    realm_management_client_uuid: "{{ get_realm_management_client_response.json[0].id }}"
  when: can_manage_clients | default(true)

- name: Get available roles for realm-management client
  ansible.builtin.uri:
    url: "{{ kc_base_url }}/admin/realms/{{ kc_realm_name }}/clients/{{ realm_management_client_uuid }}/roles"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_admin_token }}"
    validate_certs: "{{ kc_validate_certs }}"
    status_code: 200
  register: get_realm_management_roles_response
  when: can_manage_clients | default(true)

- name: Extract required roles (view-users and manage-users)
  ansible.builtin.set_fact:
    required_roles: "{{ get_realm_management_roles_response.json | selectattr('name', 'in', ['view-users', 'manage-users']) | list }}"
  when: can_manage_clients | default(true)

- name: Assign view-users and manage-users roles to netbird-backend service account
  ansible.builtin.uri:
    url: "{{ kc_base_url }}/admin/realms/{{ kc_realm_name }}/users/{{ netbird_backend_service_account_user_id }}/role-mappings/clients/{{ realm_management_client_uuid }}"
    method: POST
    headers:
      Authorization: "Bearer {{ keycloak_admin_token }}"
      Content-Type: "application/json"
    body: "{{ required_roles | to_json }}"
    body_format: json
    validate_certs: "{{ kc_validate_certs }}"
    status_code: [204, 409]
  register: assign_roles_response
  failed_when: false
  when: can_manage_clients | default(true)

# ========================================
# STEP 8: Get client secret
# ========================================
- name: Get netbird-backend client secret
  ansible.builtin.uri:
    url: "{{ kc_base_url }}/admin/realms/{{ kc_realm_name }}/clients/{{ netbird_backend_client_uuid }}/client-secret"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_admin_token }}"
    validate_certs: "{{ kc_validate_certs }}"
    status_code: 200
  register: get_backend_client_secret_response
  when: can_manage_clients | default(true)
  no_log: true

- name: Display warning if client secret not retrieved
  ansible.builtin.debug:
    msg:
      - "‚ö†Ô∏è  WARNING: Could not retrieve client secret due to insufficient permissions"
      - "You will need to manually provide the netbird-backend client secret"
      - "Get it from: Keycloak Admin Console ‚Üí Clients ‚Üí netbird-backend ‚Üí Credentials tab"
  when: not (can_manage_clients | default(true))

# ========================================
# STEP 9: Set final configuration facts
# ========================================
- name: Set NetBird Keycloak configuration facts
  ansible.builtin.set_fact:
    netbird_keycloak_issuer_url: "{{ kc_public_url }}/realms/{{ kc_realm_name }}"
    netbird_keycloak_oidc_endpoint: "{{ keycloak_oidc_configuration_endpoint }}"
    netbird_keycloak_admin_endpoint: "{{ kc_public_url }}/admin/realms/{{ kc_realm_name }}"
    netbird_keycloak_client_id: "{{ keycloak_client_netbird }}"
    netbird_keycloak_audience: "{{ keycloak_client_netbird }}"
    netbird_mgmt_client_id: "{{ keycloak_client_netbird_backend }}"
    netbird_mgmt_client_secret: "{{ get_backend_client_secret_response.json.value if (can_manage_clients | default(true)) else 'GET_FROM_KEYCLOAK_ADMIN_CONSOLE' }}"
  no_log: true

# ========================================
# STEP 10: Display configuration summary
# ========================================
- name: Display Keycloak configuration (API mode)
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "‚úÖ External Keycloak Configuration Complete"
      - "=========================================="
      - "Mode: EXTERNAL (Remote Keycloak via API)"
      - "Realm: {{ kc_realm_name }}"
      - "Host: {{ kc_public_url }}"
      - ""
      - "OIDC Configuration:"
      - "  Endpoint: {{ netbird_keycloak_oidc_endpoint }}"
      - "  Issuer: {{ netbird_keycloak_issuer_url }}"
      - ""
      - "Frontend Client (Public):"
      - "  Client ID: {{ netbird_keycloak_client_id }}"
      - "  Audience: {{ netbird_keycloak_audience }}"
      - "  Status: {{ 'Created' if not netbird_client_exists else 'Updated/Existing' }}"
      - ""
      - "Backend Client (Service Account):"
      - "  Client ID: {{ netbird_mgmt_client_id }}"
      - "  Secret: {{ '<RETRIEVED>' if (can_manage_clients | default(true)) else '<MANUAL - CHECK ADMIN CONSOLE>' }}"
      - "  Admin API: {{ netbird_keycloak_admin_endpoint }}"
      - "  Status: {{ 'Created' if not netbird_backend_client_exists else 'Existing' }}"
      - ""
      - "Configuration exported for NetBird deployment"
      - "=========================================="

# ========================================
# STEP 11: Save configuration to file
# ========================================
- name: Save realm configuration to local file (external mode)
  ansible.builtin.copy:
    content: |
      # Keycloak Configuration for NetBird (External Mode)
      # Generated: {{ ansible_date_time.iso8601 }}
      
      NETBIRD_KEYCLOAK_ISSUER={{ netbird_keycloak_issuer_url }}
      NETBIRD_KEYCLOAK_OIDC_ENDPOINT={{ netbird_keycloak_oidc_endpoint }}
      NETBIRD_KEYCLOAK_ADMIN_ENDPOINT={{ netbird_keycloak_admin_endpoint }}
      NETBIRD_CLIENT_ID={{ netbird_keycloak_client_id }}
      NETBIRD_AUDIENCE={{ netbird_keycloak_audience }}
      NETBIRD_MGMT_CLIENT_ID={{ netbird_mgmt_client_id }}
      NETBIRD_MGMT_CLIENT_SECRET={{ netbird_mgmt_client_secret }}
    dest: "./{{ kc_realm_name }}-external-config.env"
    mode: '0600'
  delegate_to: localhost
