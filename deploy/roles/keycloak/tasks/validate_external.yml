---
# Validate external Keycloak connection
# Assumes: Realm and clients ALREADY EXIST (created by boss)
# Does: Validates connectivity and extracts configuration

- name: Validate OIDC endpoint is configured
  ansible.builtin.assert:
    that:
      - keycloak_oidc_configuration_endpoint is defined
      - keycloak_oidc_configuration_endpoint | length > 0
      - vault_netbird_backend_client_secret is defined
      - vault_netbird_backend_client_secret | length > 0
      - vault_netbird_backend_client_secret != "YOUR_CLIENT_SECRET_FROM_BOSS"
    fail_msg: |
      External Keycloak mode requires:
      
      1. OIDC endpoint: Already configured in keycloak.yml ✓
      2. Backend client secret: Set in all.yml
      
      Edit group_vars/all.yml and replace:
        vault_netbird_backend_client_secret: "YOUR_CLIENT_SECRET_FROM_BOSS"
      
      With the real secret from your boss (should look like a long random string)

- name: Validate OIDC configuration endpoint accessibility
  ansible.builtin.uri:
    url: "{{ keycloak_oidc_configuration_endpoint }}"
    method: GET
    validate_certs: "{{ keycloak_validate_certs }}"
    status_code: 200
  register: oidc_config_response
  failed_when: >
    oidc_config_response.status != 200 or
    'issuer' not in oidc_config_response.json or
    'token_endpoint' not in oidc_config_response.json

- name: Extract realm information
  ansible.builtin.set_fact:
    keycloak_base_url: "{{ oidc_config_response.json.issuer | regex_replace('/realms/.*$', '') }}"
    extracted_realm_name: "{{ oidc_config_response.json.issuer | regex_replace('^.*/realms/', '') }}"
    netbird_backend_client_secret: "{{ vault_netbird_backend_client_secret }}"

- name: Display discovered information
  ansible.builtin.debug:
    msg:
      - "✓ Keycloak Base URL: {{ keycloak_base_url }}"
      - "✓ Realm: {{ extracted_realm_name }}"
      - "✓ Issuer: {{ oidc_config_response.json.issuer }}"
      - "✓ Mode: Using existing clients (no admin access needed)"

# Validation complete - will export configuration for NetBird
