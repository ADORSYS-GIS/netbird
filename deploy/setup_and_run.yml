---
# ============================================================
# Bootstrap Playbook - Installs Collections Then Runs Main Playbook
# ============================================================
# This playbook:
# 1. Installs required Ansible collections on localhost
# 2. Imports the main Keycloak configuration playbook
# ============================================================

- name: Bootstrap - Install Required Ansible Collections
  hosts: localhost
  connection: local
  gather_facts: no
  become: no
  
  tasks:
    - name: Check if vault file exists
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/group_vars/all.yml"
      register: vault_file
    
    - name: Create all.yml if missing
      ansible.builtin.copy:
        dest: "{{ playbook_dir }}/group_vars/all.yml"
        content: |
          ---
          # NetBird External Keycloak Configuration
          # Boss provides these credentials from existing setup
          # ============================================================
          
          # NetBird Backend Client (Service Account)
          # Get this from your boss - it's the netbird-backend client secret
          vault_netbird_backend_client_secret: "YOUR_CLIENT_SECRET_FROM_BOSS"
          
          # Note: Client IDs are public (netbird-client, netbird-backend)
          # Only the secret above needs to be kept private
        mode: '0600'
      when: not vault_file.stat.exists
    
    - name: Display vault file status
      ansible.builtin.debug:
        msg: |
          {% if vault_file.stat.exists %}
          ✓ Variables file found: group_vars/all.yml
          {% else %}
          ⚠️  Created variables file: group_vars/all.yml
          ⚠️  IMPORTANT: Add netbird-backend client secret!
          ⚠️  Edit with: nano group_vars/all.yml
          ⚠️  Ask your boss for the netbird-backend secret
          {% endif %}
    
    - name: Install required Ansible collections
      ansible.builtin.command:
        cmd: ansible-galaxy collection install -r {{ playbook_dir }}/requirements.yml --force
      register: collection_install
      changed_when: "'installed' in collection_install.stdout or 'Installing' in collection_install.stdout"
    
    - name: Display collection installation status
      ansible.builtin.debug:
        msg: |
          ✓ Required collections installed/verified:
            - community.docker
            - community.general
            - ansible.posix

# ============================================================
# Import Main Keycloak Configuration Playbook
# ============================================================
- name: Import Keycloak Configuration Playbook
  ansible.builtin.import_playbook: deploy_keycloak.yml
